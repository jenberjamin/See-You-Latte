<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conversations - See You Latte</title>

  <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-storage.js"></script>

  <script src="js/core.js"></script>

  <style>
    /* AESTHETIC: Quiet Luxury / Glassmorphism */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Georgia', serif; /* Pure serif elegance */
      height: 100vh;
      /* The Dark Cafe Background */
      background: url('https://i.imgur.com/n06Kgqz.jpeg') no-repeat center center fixed; 
      background-size: cover;
      color: #e0e0e0; /* Softer white */
      padding: 40px;
      overflow-y: auto;
      position: relative;
    }

    /* Dark Overlay so text is readable */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7); /* 70% darkness */
      z-index: -1;
    }

    h2 {
      font-size: 32px;
      margin-bottom: 10px;
      text-align: center;
      letter-spacing: 4px;
      text-transform: uppercase;
      font-weight: normal;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      color: #fff;
    }

    .subtitle {
      text-align: center;
      color: #aaa;
      font-size: 14px;
      font-style: italic;
      margin-bottom: 40px;
      letter-spacing: 1px;
    }

    /* NAVIGATION */
    .back-btn {
      position: absolute;
      left: 30px;
      top: 30px;
      color: #ccc;
      padding: 8px 16px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 2px;
      text-decoration: none;
      transition: all 0.3s;
      border-bottom: 1px solid transparent;
    }

    .back-btn:hover { color: white; border-bottom: 1px solid white; }

    /* ROOM LIST CONTAINER */
    .room-list {
      max-width: 700px; /* Slightly wider */
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding-bottom: 100px;
    }
    
    #roomListSpinner {
      text-align: center;
      color: #aaa;
      font-style: italic;
      padding: 60px;
    }

    /* THE GLASS CARDS */
    .room-item {
      /* Glass Effect */
      background: rgba(30, 30, 30, 0.6);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      
      padding: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    .room-item:hover {
      background: rgba(50, 50, 50, 0.7);
      transform: translateY(-2px);
      border-color: rgba(255, 255, 255, 0.3);
      box-shadow: 0 10px 20px rgba(0,0,0,0.4);
    }

    .room-item.pinned { 
      border-left: 4px solid #d4af37; /* Gold accent for pinned items */
      background: rgba(45, 40, 30, 0.7); /* Slightly warmer tint */
    }

    .room-info { flex: 1; }

    .room-title {
      font-size: 20px;
      margin-bottom: 8px;
      display: flex;
      gap: 10px;
      align-items: center;
      letter-spacing: 1px;
      color: white;
    }

    .room-type-badge {
      font-size: 10px;
      padding: 4px 8px;
      border: 1px solid #d4af37; /* Gold border */
      color: #d4af37;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .room-meta { 
      font-size: 13px; 
      color: #888; 
      font-family: sans-serif; /* Clean contrast for numbers */
      letter-spacing: 0.5px;
    }

    /* ACTIONS */
    .room-actions { display: flex; gap: 15px; align-items: center; }

    .star-btn {
      background: transparent;
      border: none;
      color: #555;
      font-size: 22px;
      cursor: pointer;
      transition: color 0.3s;
    }
    .star-btn:hover { color: #d4af37; }
    .star-btn.pinned { color: #d4af37; }

    /* MAIN BUTTON */
    .create-room-btn {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      padding: 18px 40px;
      border: 1px solid rgba(255,255,255,0.4);
      font-family: 'Georgia', serif;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 3px;
      cursor: pointer;
      margin: 10px auto 50px auto; /* Centered */
      display: block;
      transition: all 0.3s;
      backdrop-filter: blur(5px);
    }

    .create-room-btn:hover {
      background: white;
      color: black;
      box-shadow: 0 0 15px rgba(255,255,255,0.2);
    }

    /* MODAL (The VIP Room) */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9); /* Very dark backdrop */
      z-index: 1000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }
    .modal.active { display: flex; }

    .modal-content {
      background: #1a1a1a;
      padding: 40px;
      border: 1px solid #333;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 20px 50px rgba(0,0,0,0.7);
      text-align: center;
    }

    .modal-content h3 { 
      color: white; 
      margin-bottom: 30px; 
      letter-spacing: 3px; 
      text-transform: uppercase;
      font-size: 18px;
    }

    .modal-content label { 
      display: block; 
      color: #888; 
      font-size: 11px; 
      text-transform: uppercase; 
      letter-spacing: 2px; 
      margin-bottom: 10px; 
      text-align: left;
    }
    
    .modal-content input, .modal-content select {
      width: 100%;
      padding: 15px;
      background: #252525;
      border: 1px solid #444;
      color: white;
      font-family: 'Georgia', serif;
      font-size: 16px;
      margin-bottom: 25px;
      outline: none;
      transition: border 0.3s;
    }

    .modal-content input:focus, .modal-content select:focus {
      border-color: #d4af37; /* Gold focus */
    }

    .modal-buttons { display: flex; gap: 10px; justify-content: center; }
    
    .modal-btn { 
      padding: 12px 30px; 
      border: none; 
      font-family: 'Georgia', serif; 
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 12px;
      cursor: pointer; 
      transition: all 0.3s;
    }
    .modal-btn.cancel { background: transparent; color: #888; border: 1px solid #444; }
    .modal-btn.cancel:hover { border-color: white; color: white; }

    .modal-btn.confirm { background: #d4af37; color: #1a1a1a; font-weight: bold; }
    .modal-btn.confirm:hover { background: white; }

  <style>
    /* ... all your CSS code is up here ... */
    /* ... */
    .btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }
  </style>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1a1a1a">
  <link rel="apple-touch-icon" href="https://i.imgur.com/LrIt4GQ.png">

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('Service Worker registered! ✅', reg))
          .catch(err => console.log('Service Worker failed ❌', err));
      });
    }
  </script>
  </head>
<body>

  <a href="See-You-Latte.html" class="back-btn">← Back</a>
  <h2>Your Conversations</h2>
  <div class="subtitle">Where stories are brewed</div>
  
  <button class="create-room-btn" id="createRoomBtn">+ Create New Room</button>
  
  <div class="room-list" id="roomList">
    <div id="roomListSpinner">Loading conversations...</div>
  </div>

  <div class="modal" id="createRoomModal">
    <div class="modal-content">
      <h3>Create New Room</h3>
      <label>Room Name</label>
      <input type="text" id="roomNameInput" maxlength="50" placeholder="e.g., Morning Coffee">
      <label>Room Type</label>
      <select id="roomTypeInput">
        <option value="regular">Regular Chat</option>
        <option value="roleplay">Roleplay (See You Latte)</option>
      </select>
      <div class="modal-buttons">
        <button class="modal-btn cancel" id="cancelCreateBtn">Cancel</button>
        <button class="modal-btn confirm" id="confirmCreateBtn">Create</button>
      </div>
    </div>
  </div>

  <script>
    // --- LOGIC ---

    // 1. Initialization
    document.addEventListener('DOMContentLoaded', () => {
      // Check if user came from Landing Page with ?action=create
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('action') === 'create') {
        document.getElementById('createRoomModal').classList.add('active');
      }
      
      // Load Rooms
      renderRoomList();
    });

    // 2. Render Rooms
    async function renderRoomList() {
      const roomListDiv = document.getElementById('roomList');
      
      try {
        const snapshot = await db.ref('rooms').once('value');
        const rooms = snapshot.val() || {};
        const ids = Object.keys(rooms);
        
        if (ids.length === 0) {
           roomListDiv.innerHTML = '<div style="text-align:center;color:#888;padding:60px">No conversations yet</div>';
           return;
        }

        // Sort: Pinned first, then by Last Active
        ids.sort((a, b) => {
          if (rooms[a].pinned && !rooms[b].pinned) return -1;
          if (!rooms[a].pinned && rooms[b].pinned) return 1;
          return (rooms[b].lastActive || 0) - (rooms[a].lastActive || 0);
        });

        // Build HTML
        const html = ids.map(id => {
          const r = rooms[id];
          const badge = r.type === 'roleplay' ? '<span class="room-type-badge roleplay">☕ Roleplay</span>' : '';
          const msgCount = r.messages ? Object.keys(r.messages).length : 0;
          
          return `
            <div class="room-item ${r.pinned ? 'pinned' : ''}" onclick="goToChat('${id}')">
              <div class="room-info">
                <div class="room-title">${escapeHTML(r.name)} ${badge}</div>
                <div class="room-meta">${msgCount} messages</div>
              </div>
              <div class="room-actions">
                <button class="star-btn ${r.pinned ? 'pinned' : ''}" onclick="event.stopPropagation(); togglePin('${id}', ${r.pinned})">★</button>
              </div>
            </div>
          `;
        }).join('');

        roomListDiv.innerHTML = html;

      } catch (e) {
        console.error("Error loading rooms:", e);
        roomListDiv.innerHTML = '<div style="text-align:center;color:#c33;padding:60px">Could not load conversations.</div>';
      }
    }

    // 3. Navigation (The Bridge)
    function goToChat(id) {
      // THIS IS THE KEY: We send the ID to the next page
      window.location.href = `See-You-Latte-Chats.html?room=${id}`;
    }

    // 4. Modal Controls
    document.getElementById('createRoomBtn').onclick = () => {
      document.getElementById('createRoomModal').classList.add('active');
    };
    document.getElementById('cancelCreateBtn').onclick = () => {
      document.getElementById('createRoomModal').classList.remove('active');
    };

    // 5. Create Room Action
    document.getElementById('confirmCreateBtn').onclick = async () => {
      const name = document.getElementById('roomNameInput').value.trim();
      const type = document.getElementById('roomTypeInput').value;
      
      if (!name) return alert("Please name your room.");

      const id = generateId(); // From core.js
      
      const newRoom = {
        id, name, type,
        created: Date.now(),
        lastActive: Date.now(),
        pinned: false,
        settings: {
          corePrompt: '', tomProfile: '', jenProfile: '', scenario: '', bgImageUrl: ''
        }
      };

      try {
        await db.ref('rooms/' + id).set(newRoom);
        // Redirect immediately to the new room
        goToChat(id);
      } catch (e) {
        console.error("Error creating room:", e);
        alert("Failed to create room.");
      }
    };

    // 6. Utility Actions (Pin/Delete)
    window.togglePin = async (id, isPinned) => {
      try {
        await db.ref('rooms/' + id + '/pinned').set(!isPinned);
        renderRoomList();
      } catch (e) { console.error(e); }
    };

    window.deleteRoom = async (id) => {
      if (!confirm('Delete this conversation? This cannot be undone.')) return;
      try {
        await db.ref('rooms/' + id).remove();
        // Also clean storage if possible, but basic remove is fine for now
        renderRoomList();
      } catch (e) { console.error(e); }
    };

    // Helper from core.js usage check
    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, function(m) {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
      });
    }
  </script>
</body>

</html>
