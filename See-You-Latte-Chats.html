<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - See You Latte</title>

  <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-storage.js"></script>

  <script src="js/core.js"></script>

  <style>
    /* --- AESTHETIC: The Private Booth (COMPLETE) --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    /* CUSTOM SCROLLBAR */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }

    body {
      font-family: 'Georgia', serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      /* Default Background */
      background: url('https://i.imgur.com/0XGxd1q.jpeg') no-repeat center center fixed;
      background-size: cover;
      color: #e0e0e0;
      overflow: hidden;
      position: relative;
    }

    /* Dark Overlay for readability */
    body::before {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.5); 
      z-index: 0;
      pointer-events: none;
    }

    /* --- GLASS HEADER --- */
    .chat-header {
      background: rgba(20, 20, 20, 0.6);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 15px 20px;
      text-align: center;
      position: relative;
      z-index: 100; /* High z-index to stay on top */
      display: flex;
      justify-content: center;
      align-items: center;
      height: 70px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .chat-header h1 {
      font-size: 18px;
      font-weight: normal;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    .room-name-display {
      font-size: 11px;
      color: #d4af37; /* Gold accent */
      letter-spacing: 1px;
      display: block;
      margin-top: 4px;
      text-transform: uppercase;
    }

    /* BUTTONS */
    .back-btn, .header-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      color: #ccc;
      padding: 6px 12px;
      font-family: 'Georgia', serif;
      cursor: pointer;
      font-size: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s;
      text-decoration: none;
    }
    .back-btn { position: absolute; left: 20px; }
    .header-actions { position: absolute; right: 20px; display: flex; gap: 8px; }
    
    .back-btn:hover, .header-btn:hover { 
      background: rgba(255,255,255,0.1); 
      border-color: white; 
      color: white; 
    }

    /* --- SEARCH BAR (Fixed!) --- */
    .search-bar {
      display: none; /* Hidden by default */
      padding: 15px;
      background: rgba(0,0,0,0.9);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      gap: 10px;
      align-items: center;
      position: absolute;
      top: 70px; /* Right below header */
      left: 0; right: 0;
      z-index: 90;
      backdrop-filter: blur(10px);
    }
    .search-bar.active { display: flex; }

    .search-input {
      flex: 1;
      padding: 8px 12px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      font-family: 'Georgia', serif;
    }
    .search-nav { display: flex; gap: 5px; align-items: center; color: #888; font-size: 12px; }
    .search-nav button { background: #444; color: white; border: none; padding: 4px 8px; cursor: pointer; }

    /* --- CHAT AREA --- */
    #chatBox {
      flex: 1;
      overflow-y: auto;
      padding: 20px 15%; 
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 1;
      scroll-behavior: smooth;
    }

    .message-wrapper {
      display: flex;
      width: 100%;
      margin-bottom: 25px;
      animation: fadeIn 0.4s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .message-wrapper.user { justify-content: flex-end; }
    .message-wrapper.bot { justify-content: flex-start; }

    .message {
      padding: 15px 25px;
      max-width: 80%;
      word-wrap: break-word;
      font-size: 14px;
      line-height: 1.7;
      font-family: 'Arial';
      position: relative;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      white-space: pre-wrap;
    }

    .message p {
      margin-bottom: 16px;
    }

    .message p:last-child {
      margin-bottom: 0;
    }

    /* User Bubble */
    .user-msg { 
      background: rgba(255, 255, 255, 0.9); 
      color: #1a1a1a; 
      border-radius: 20px 20px 0 20px; 
    }

    /* Bot Bubble */
    .bot-msg { 
      background: rgba(0, 0, 0, 0.6); 
      backdrop-filter: blur(5px);
      color: #e8e8e8; 
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px 20px 20px 0; 
    }
    
    .message img { max-width: 100%; border-radius: 8px; margin-top: 10px; border: 1px solid rgba(255,255,255,0.2); }

    /* Message Actions (Delete/Regen) */
    .message-actions {
      display: flex; gap: 5px; opacity: 0; transition: opacity 0.2s; margin-top: 5px;
    }
    .message-wrapper:hover .message-actions { opacity: 1; }
    .message-action-btn {
      background: transparent; color: #666; border: none; cursor: pointer; font-size: 14px;
    }
    .message-action-btn:hover { color: #d4af37; }

    /* --- INPUT AREA --- */
    .input-area {
      padding: 20px 15%;
      background: rgba(20, 20, 20, 0.8);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      gap: 15px;
      align-items: flex-end;
      z-index: 10;
    }

    #messageInput {
      flex: 1;
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      color: white;
      font-family: 'Georgia', serif;
      font-size: 16px;
      resize: none;
      min-height: 50px;
      max-height: 150px;
      transition: border 0.3s, background 0.3s;
    }
    #messageInput:focus {
      outline: none;
      border-color: #d4af37;
      background: rgba(255,255,255,0.1);
    }

    .input-buttons { display: flex; gap: 10px; }
    
    #sendBtn {
      background: transparent;
      color: #d4af37;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 20px; /* Pill shape */
      padding: 0 25px;     /* Wider */
      height: 50px;
      font-family: 'Georgia', serif; 
      font-size: 14px;     /* Slightly larger text */
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.3s;
    }
    #sendBtn:hover {
      background: #d4af37;
      color: #000;
      border-color: #d4af37;
    }

    /* --- SETTINGS PANEL (Restored & Styled) --- */
    .settings-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1999; backdrop-filter: blur(2px); }
    .settings-panel {
      position: fixed; right: 0; top: 0; width: 450px; max-width: 85vw; height: 100vh;
      background: #1a1a1a; 
      border-left: 1px solid #333;
      transform: translateX(100%); transition: transform 0.3s ease;
      z-index: 2000; display: flex; flex-direction: column; overflow-y: auto;
      box-shadow: -10px 0 30px rgba(0,0,0,0.5);
    }
    .settings-panel.active { transform: translateX(0); }
    .settings-overlay.active { display: block; }
    
    .settings-content { padding: 30px; }
    .settings-section { margin-bottom: 25px; }
    
    .settings-section h3 { 
      border-bottom: 1px solid #d4af37; 
      padding-bottom: 8px; 
      margin-bottom: 15px; 
      font-weight: normal; 
      color: #d4af37;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-size: 14px;
    }
    
    .settings-section textarea, .settings-section input {
      width: 100%; padding: 12px; 
      background: rgba(255,255,255,0.05); 
      border: 1px solid #444; 
      color: white;
      font-family: 'Georgia', serif; resize: vertical; min-height: 80px;
    }
    .settings-section input { min-height: 40px; }
    
    .settings-section textarea:focus, .settings-section input:focus {
      outline: none; border-color: #d4af37;
    }

    /* --- MODALS & GALLERY (Restored) --- */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; justify-content: center; align-items: center; }
    .modal.active { display: flex; }
    
    .gallery-content {
      width: 80vw; height: 80vh; background: #1a1a1a; overflow-y: auto; padding: 20px;
      display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;
    }
    .gallery-item { height: 150px; background-size: cover; background-position: center; cursor: pointer; border: 1px solid #444; transition: transform 0.2s;}
    .gallery-item:hover { transform: scale(1.05); border-color: white; }
    .lightbox-img { max-width: 95vw; max-height: 95vh; object-fit: contain; }

/* --- MODAL BEAUTIFICATION (Edit & Delete) --- */
    
    /* 1. The Box Itself */
    .modal-content {
      background: #1a1a1a;       /* Dark background */
      border: 1px solid #333;    /* Subtle border */
      color: #e0e0e0;            /* Soft white text */
      font-family: 'Georgia', serif;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.7); /* Deep shadow */
    }

    /* 2. The Header */
    .modal-content h3 {
      color: #d4af37;            /* Gold accent */
      border-bottom: 1px solid #444;
      padding-bottom: 15px;
      margin-bottom: 25px;
      font-weight: normal;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-size: 16px;
    }

    /* 3. The Text Area (The most important part!) */
    #editInput {
      width: 100%;
      background: rgba(255, 255, 255, 0.05); /* Slight tint */
      border: 1px solid #444;
      color: white;
      font-family: 'Georgia', serif;
      font-size: 16px;
      line-height: 1.6;
      padding: 15px;
      border-radius: 4px;
      resize: vertical;
      margin-bottom: 25px;
      outline: none;
      transition: border 0.3s;
    }

    #editInput:focus {
      border-color: #d4af37; /* Glows gold when typing */
      background: rgba(255, 255, 255, 0.08);
    }

    /* 4. The Buttons */
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
    }

    .modal-btn {
      padding: 10px 25px;
      font-family: 'Georgia', serif;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 12px;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.3s;
    }

    /* Cancel Button */
    .modal-btn.cancel {
      background: transparent;
      border: 1px solid #555;
      color: #888;
    }
    .modal-btn.cancel:hover {
      border-color: #e0e0e0;
      color: #e0e0e0;
    }

    /* Save/Confirm Button */
    .modal-btn.confirm {
      background: #d4af37;
      border: 1px solid #d4af37;
      color: #1a1a1a;
      font-weight: bold;
    }
    .modal-btn.confirm:hover {
      background: white;
      border-color: white;
    }
  <style>
    /* ... all your CSS code is up here ... */
    /* ... */
    .btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }
  </style>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1a1a1a">
  <link rel="apple-touch-icon" href="https://i.imgur.com/LrIt4GQ.png">

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('Service Worker registered! ✅', reg))
          .catch(err => console.log('Service Worker failed ❌', err));
      });
    }
  </script>
  </head>
<body>

  <div class="chat-header">
    <a href="See-You-Latte-Rooms.html" class="back-btn">← Back</a>
    <div>
      <h1>Thomas Thompson</h1>
      <span class="room-name-display" id="currentRoomName">Loading...</span>
    </div>
    <div class="header-actions">
      <button class="header-btn" id="settingsBtn">Customize</button>
    </div>
  </div>

  <div id="chatBox"></div>

  <div class="input-area">
    <textarea id="messageInput" placeholder="Type your message..." rows="1"></textarea>
    <div class="input-buttons">
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <div class="settings-overlay" id="settingsOverlay"></div>
  <div class="settings-panel" id="settingsPanel">
    <div style="padding: 20px; background: #000; display: flex; justify-content: space-between;">
      <h2>Room Settings</h2>
      <button id="closeSettingsBtn" style="background:none; border:none; color:white; cursor:pointer;">✕</button>
    </div>
    <div class="settings-content">
      <div class="settings-section">
        <h3>Core Prompt</h3>
        <textarea id="corePromptInput" placeholder="Tom's behavior..."></textarea>
      </div>
      <div class="settings-section">
        <h3>Tom's Profile</h3>
        <textarea id="tomProfileInput" placeholder="Personality..."></textarea>
      </div>
      <div class="settings-section">
        <h3>Jen's Profile</h3>
        <textarea id="jenProfileInput" placeholder="About you..."></textarea>
      </div>
      <div class="settings-section">
        <h3>Scenario</h3>
        <textarea id="scenarioInput" placeholder="Context..."></textarea>
      </div>
      <div class="settings-section">
        <h3>Background Image</h3>
        <input type="text" id="bgImageUrlInput" placeholder="https://...">
      </div>
      <button id="saveSettingsBtn" style="width:100%; padding:15px; background:white; color: #1a1a1a; font-weight:bold; cursor:pointer; border: none; font-family: 'Georgia', serif; letter-spacing: 1px;">SAVE SETTINGS</button>
      
      <div style="margin-top: 40px; border-top: 1px solid #333; padding-top: 30px; text-align: center;">
        <button id="deleteRoomBtn" style="width:100%; padding:15px; background: transparent; border: 1px solid #ff6b6b; color: #ff6b6b; font-family: 'Georgia', serif; font-weight:bold; cursor:pointer; letter-spacing: 1px; transition: all 0.3s;">DELETE CONVERSATION</button>
      </div>

    </div>
  </div>

<div class="modal" id="deleteModal">
    <div class="modal-content" style="max-width: 300px;">
      <h3 style="color: #ff6b6b; border-bottom-color: #ff6b6b;">Delete Message?</h3>
      <p style="color: #ccc; margin-bottom: 25px; font-size: 14px;">This cannot be undone.</p>
      <div class="modal-buttons">
        <button class="modal-btn cancel" id="cancelDeleteBtn">Cancel</button>
        <button class="modal-btn confirm" id="confirmDeleteBtn" style="background: #ff6b6b; color: white;">Delete</button>
      </div>
    </div>
  </div>

  <div class="modal" id="editModal">
    <div class="modal-content" style="width: 500px; max-width: 90vw;">
      <h3>Edit Message</h3>
      <textarea id="editInput" style="height: 200px; margin-bottom: 20px; line-height: 1.6;"></textarea>
      <div class="modal-buttons">
        <button class="modal-btn cancel" id="cancelEditBtn">Cancel</button>
        <button class="modal-btn confirm" id="confirmEditBtn">Save Changes</button>
      </div>
    </div>
  </div>

<div class="modal" id="regenModal">
    <div class="modal-content" style="max-width: 350px;">
      <h3 style="color: #d4af37; border-bottom-color: #d4af37;">Try Again?</h3>
      <p style="color: #ccc; margin-bottom: 25px; font-size: 14px; line-height: 1.5;">
        This will delete the current response and ask Tom to write a new one.
      </p>
      <div class="modal-buttons">
        <button class="modal-btn cancel" id="cancelRegenBtn">Cancel</button>
        <button class="modal-btn confirm" id="confirmRegenBtn">Regenerate</button>
      </div>
    </div>
  </div>

<div class="modal" id="deleteRoomModal">
    <div class="modal-content" style="max-width: 400px; border: 1px solid #ff6b6b;">
      <h3 style="color: #ff6b6b; border-bottom-color: #ff6b6b;">End Conversation?</h3>
      <p style="color: #ccc; margin-bottom: 25px; font-size: 14px; line-height: 1.6;">
        You are about to delete <strong><span id="delRoomNameDisplay">this chat</span></strong>. 
        <br><br>
        This will permanently erase all messages, characters, and settings associated with this room. 
        <span style="color: #ff6b6b;">This cannot be undone.</span>
      </p>
      <div class="modal-buttons">
        <button class="modal-btn cancel" id="cancelDeleteRoomBtn">Keep It</button>
        <button class="modal-btn confirm" id="confirmDeleteRoomBtn" style="background: #ff6b6b; border-color: #ff6b6b; color: white;">Delete Forever</button>
      </div>
    </div>
  </div>


  <script>


    // --- THE LOGIC ---

    // 1. Get Room ID
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room');
    
    // Safety: No ID? Go back to lobby.
    if (!roomId) window.location.href = 'See-You-Latte-Rooms.html';

    let currentRoomData = null;
    let searchMatches = [];
    let abortController = null;
    let targetKey = null;

    // 2. Load Room Data
    async function loadRoom() {
      try {
        const snapshot = await db.ref('rooms/' + roomId).once('value');
        currentRoomData = snapshot.val();
        
        if (!currentRoomData) {
          alert("Room not found.");
          window.location.href = 'See-You-Latte-Rooms.html';
          return;
        }

        // Setup UI
        document.getElementById('currentRoomName').textContent = currentRoomData.name;
        applyBackground(currentRoomData);
        renderMessages();

      } catch (e) {
        console.error("Error loading room:", e);
      }
    }

    // 3. Render Messages
    function renderMessages() {
      const chatBox = document.getElementById('chatBox');
      chatBox.innerHTML = '';
      const msgs = currentRoomData.messages || {};
      
      // Sort logic
      const sortedKeys = Object.keys(msgs).sort((a, b) => {
          const aIsMigrated = a.startsWith('msg_');
          const bIsMigrated = b.startsWith('msg_');
          if (aIsMigrated && bIsMigrated) return parseInt(a.split('_')[1]) - parseInt(b.split('_')[1]);
          if (aIsMigrated) return -1;
          if (bIsMigrated) return 1;
          return a.localeCompare(b);
      });

      sortedKeys.forEach(key => {
        addMessageToDOM(msgs[key], key);
      });
      
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function addMessageToDOM(msgData, key) {
      const type = msgData.role === 'user' ? 'user' : 'bot';
      const wrapper = document.createElement('div');
      wrapper.className = `message-wrapper ${type}`;
      wrapper.id = `msg-${key}`; // Give it an ID so we can find it later to update it

      const contentDiv = document.createElement('div');
      contentDiv.className = `message ${type}-msg`;
      // Use core.js markdown parser if available, or raw text
      contentDiv.innerHTML = (typeof parseMarkdown === 'function') ? parseMarkdown(msgData.content) : msgData.content;

      // ACTIONS CONTAINER
      const actions = document.createElement('div');
      actions.className = 'message-actions';
      
      // 1. EDIT BUTTON (For everyone)
      const editBtn = document.createElement('button');
      editBtn.className = 'message-action-btn';
      editBtn.innerHTML = '✎'; // Pencil Icon
      editBtn.title = "Edit";
      editBtn.onclick = () => openEditModal(key, msgData.content);
      actions.appendChild(editBtn);

      // 2. DELETE BUTTON (For everyone)
      const delBtn = document.createElement('button');
      delBtn.className = 'message-action-btn';
      delBtn.innerHTML = '×'; // X Icon
      delBtn.title = "Delete";
      delBtn.onclick = () => openDeleteModal(key);
      actions.appendChild(delBtn);

      // 3. REGENERATE (Bot only) - Optional, kept it just in case
      if (type === 'bot') {
        const regenBtn = document.createElement('button');
        regenBtn.className = 'message-action-btn';
        regenBtn.innerHTML = '↻';
        regenBtn.title = "Regenerate";
        regenBtn.onclick = () => regenerateMessage(key);
        actions.appendChild(regenBtn);
      }

      // Order: User (Actions Left, Text Right) | Bot (Text Left, Actions Right)
      if (type === 'user') {
        wrapper.appendChild(actions); // Actions first
        wrapper.appendChild(contentDiv);
      } else {
        wrapper.appendChild(contentDiv);
        wrapper.appendChild(actions); // Actions last
      }

      document.getElementById('chatBox').appendChild(wrapper);
    }

    // 4. Send Message & Emergency Brake
    const sendBtn = document.getElementById('sendBtn');
    
    sendBtn.onclick = () => {
      // If we are currently generating, this button acts as STOP
      if (abortController) {
        abortController.abort();
        abortController = null;
        resetSendButton();
        // Remove the typing indicator if it exists
        const typing = document.getElementById('typingIndicator');
        if(typing) typing.remove();
        return;
      }
      // Otherwise, it acts as SEND
      sendMessage();
    };

    document.getElementById('messageInput').addEventListener('keydown', (e) => {
      // Only send if CTRL + ENTER (or CMD + ENTER) is pressed
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        sendMessage();
      }
      // Pure "Enter" will just do a normal line break now.
    });

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text) return;

      input.value = '';
      
      // A. Save User Msg
      const userRef = await db.ref(`rooms/${roomId}/messages`).push({ role: 'user', content: text });
      await db.ref(`rooms/${roomId}/lastActive`).set(Date.now());
      
      // Update Local & UI
      if (!currentRoomData.messages) currentRoomData.messages = {};
      currentRoomData.messages[userRef.key] = { role: 'user', content: text };
      addMessageToDOM({ role: 'user', content: text }, userRef.key);
      
      // B. Trigger Bot
      await triggerBotResponse();
    }

    async function triggerBotResponse() {
      // 1. UI: Show Typing & Change Button to STOP
      const typing = document.createElement('div');
      typing.id = 'typingIndicator';
      typing.textContent = 'Tom is writing...';
      typing.style.padding = '15px 25px';
      typing.style.color = '#888';
      typing.style.fontStyle = 'italic';
      document.getElementById('chatBox').appendChild(typing);
      document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;

      // CHANGE BUTTON TO STOP
      const sendBtn = document.getElementById('sendBtn');
      sendBtn.textContent = "STOP"; 
      sendBtn.style.borderColor = "#ff6b6b"; 
      sendBtn.style.color = "#ff6b6b";

      // Initialize the brake
      abortController = new AbortController();

      try {
        // Build Prompt
        const settings = currentRoomData.settings || {};
        const systemPrompt = [
          settings.corePrompt || "You are a helpful AI.", 
          settings.tomProfile ? `\n\nTOM: ${settings.tomProfile}` : '',
          settings.jenProfile ? `\n\nJEN: ${settings.jenProfile}` : '',
          settings.scenario ? `\n\nCONTEXT: ${settings.scenario}` : ''
        ].join('');

        const msgs = currentRoomData.messages || {};
        const sortedKeys = Object.keys(msgs).sort((a, b) => {
            const aIsMigrated = a.startsWith('msg_');
            const bIsMigrated = b.startsWith('msg_');
            if (aIsMigrated && bIsMigrated) return parseInt(a.split('_')[1]) - parseInt(b.split('_')[1]);
            if (aIsMigrated) return -1;
            if (bIsMigrated) return 1;
            return a.localeCompare(b);
        });

        const apiMessages = [
          { role: 'system', content: systemPrompt },
          ...sortedKeys.map(k => ({ role: msgs[k].role, content: msgs[k].content }))
        ];

        // Call API with SIGNAL (This enables the STOP)
        // NOTE: Make sure PROXY_URL is defined in your core.js or replace it with your actual URL string
        const res = await fetch(PROXY_URL, { 
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages: apiMessages }),
          signal: abortController.signal // <--- THE KEY PART
        });
        
        const data = await res.json();
        const botText = data.choices?.[0]?.message?.content || '...';

        if(document.getElementById('typingIndicator')) document.getElementById('typingIndicator').remove();

        // Save Bot Msg
        const botRef = await db.ref(`rooms/${roomId}/messages`).push({ role: 'assistant', content: botText });
        if (!currentRoomData.messages) currentRoomData.messages = {};
        currentRoomData.messages[botRef.key] = { role: 'assistant', content: botText };
        addMessageToDOM({ role: 'assistant', content: botText }, botRef.key);

      } catch (e) {
        if (e.name === 'AbortError') {
          console.log("Generation stopped by user.");
        } else {
          console.error(e);
        }
        if(document.getElementById('typingIndicator')) document.getElementById('typingIndicator').remove();
      } finally {
        // ALWAYS RESET BUTTON
        resetSendButton();
        abortController = null;
      }
    }

    // Helper to reset button style
    function resetSendButton() {
      const sendBtn = document.getElementById('sendBtn');
      sendBtn.textContent = "Send";
      sendBtn.style.borderColor = "rgba(255,255,255,0.2)";
      sendBtn.style.color = "#d4af37";
    }

    // 5. Utility Functions (Delete, Regen, Background)
    async function deleteMessage(key) {
      if(!confirm("Delete this?")) return;
      await db.ref(`rooms/${roomId}/messages/${key}`).remove();
      location.reload(); // Simple reload to refresh state
    }

    // Global variable to track which message we are regenerating
    let regenKey = null;

    function regenerateMessage(key) {
      regenKey = key;
      document.getElementById('regenModal').classList.add('active');
    }

    // Cancel Button
    document.getElementById('cancelRegenBtn').onclick = () => {
      document.getElementById('regenModal').classList.remove('active');
      regenKey = null;
    };

    // Confirm Button
    document.getElementById('confirmRegenBtn').onclick = async () => {
      if (!regenKey) return;

      // 1. Close Modal
      document.getElementById('regenModal').classList.remove('active');

      // 2. Remove the old message from Firebase
      await db.ref(`rooms/${roomId}/messages/${regenKey}`).remove();
      
      // 3. Remove from UI
      const el = document.getElementById(`msg-${regenKey}`);
      if(el) el.remove();
      
      // 4. Update local data
      if(currentRoomData.messages && currentRoomData.messages[regenKey]) {
        delete currentRoomData.messages[regenKey];
      }

      regenKey = null;

      // 5. Trigger the AI again (Auto-activates the STOP button)
      await triggerBotResponse();
    };

    function applyBackground(room) {
      // 1. Check for specific custom URL
      if (room.settings?.bgImageUrl) {
        document.body.style.backgroundImage = `url(${room.settings.bgImageUrl})`;
        document.body.classList.add('custom-bg');
      } 
      // 2. Roleplay default
      else if (room.type === 'roleplay') {
         document.body.style.backgroundImage = "url('https://i.imgur.com/QZi6LEk.png')";
      } 
      // 3. REGULAR CHAT FALLBACK (Important!)
      else {
         // Reset to CSS default (The Dark Cafe)
         document.body.style.backgroundImage = ""; 
      }
    }

    // 6. Settings Handling
    document.getElementById('settingsBtn').onclick = () => {
      const s = currentRoomData.settings || {};
      document.getElementById('corePromptInput').value = s.corePrompt || '';
      document.getElementById('tomProfileInput').value = s.tomProfile || '';
      document.getElementById('jenProfileInput').value = s.jenProfile || '';
      document.getElementById('scenarioInput').value = s.scenario || '';
      document.getElementById('bgImageUrlInput').value = s.bgImageUrl || '';
      document.getElementById('settingsPanel').classList.add('active');
      document.getElementById('settingsOverlay').classList.add('active');
    };

    document.getElementById('saveSettingsBtn').onclick = async () => {
      const newSettings = {
        corePrompt: document.getElementById('corePromptInput').value,
        tomProfile: document.getElementById('tomProfileInput').value,
        jenProfile: document.getElementById('jenProfileInput').value,
        scenario: document.getElementById('scenarioInput').value,
        bgImageUrl: document.getElementById('bgImageUrlInput').value
      };
      await db.ref(`rooms/${roomId}/settings`).set(newSettings);
      location.reload();
    };

    document.getElementById('closeSettingsBtn').onclick = () => {
      document.getElementById('settingsPanel').classList.remove('active');
      document.getElementById('settingsOverlay').classList.remove('active');
    };

    // 7. Auto-Grow Textarea
    const tx = document.getElementById('messageInput');
    tx.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });

// --- DELETE LOGIC ---
    function openDeleteModal(key) {
      targetKey = key;
      document.getElementById('deleteModal').classList.add('active');
    }

    document.getElementById('cancelDeleteBtn').onclick = () => {
      document.getElementById('deleteModal').classList.remove('active');
      targetKey = null;
    };

    document.getElementById('confirmDeleteBtn').onclick = async () => {
      if (!targetKey) return;
      
      // Remove from Firebase
      await db.ref(`rooms/${roomId}/messages/${targetKey}`).remove();
      
      // Remove from UI immediately
      const el = document.getElementById(`msg-${targetKey}`);
      if (el) el.remove();
      
      // Update local data
      if (currentRoomData.messages) delete currentRoomData.messages[targetKey];

      // Close modal
      document.getElementById('deleteModal').classList.remove('active');
      targetKey = null;
    };

    // --- EDIT LOGIC ---
    function openEditModal(key, currentContent) {
      targetKey = key;
      const textArea = document.getElementById('editInput');
      textArea.value = currentContent; // Fill with current text
      document.getElementById('editModal').classList.add('active');
    }

    document.getElementById('cancelEditBtn').onclick = () => {
      document.getElementById('editModal').classList.remove('active');
      targetKey = null;
    };

    document.getElementById('confirmEditBtn').onclick = async () => {
      if (!targetKey) return;
      
      const newContent = document.getElementById('editInput').value.trim();
      if (!newContent) return alert("Message cannot be empty.");

      // Update Firebase
      await db.ref(`rooms/${roomId}/messages/${targetKey}/content`).set(newContent);
      
      // Update UI (Refresh the specific bubble text)
      const el = document.getElementById(`msg-${targetKey}`);
      if (el) {
        // Find the text container inside the wrapper
        const bubble = el.querySelector('.message');
        if (bubble) {
           bubble.innerHTML = (typeof parseMarkdown === 'function') ? parseMarkdown(newContent) : newContent;
           // Also update the Edit button's listener to hold the new text
           const editBtn = el.querySelector('.message-action-btn[title="Edit"]');
           if (editBtn) editBtn.onclick = () => openEditModal(targetKey, newContent);
        }
      }

      // Update local data
      if (currentRoomData.messages && currentRoomData.messages[targetKey]) {
        currentRoomData.messages[targetKey].content = newContent;
      }

      document.getElementById('editModal').classList.remove('active');
      targetKey = null;
    };

// --- DELETE ROOM LOGIC (Settings) ---
    
    // 1. Trigger the Modal
    document.getElementById('deleteRoomBtn').onclick = () => {
      // Show the room name in the warning text for safety
      document.getElementById('delRoomNameDisplay').textContent = currentRoomData.name;
      
      // Close settings panel first so the modal is front and center
      document.getElementById('settingsPanel').classList.remove('active');
      document.getElementById('settingsOverlay').classList.remove('active');
      
      // Open the Danger Modal
      document.getElementById('deleteRoomModal').classList.add('active');
    };

    // 2. Cancel Action
    document.getElementById('cancelDeleteRoomBtn').onclick = () => {
      document.getElementById('deleteRoomModal').classList.remove('active');
    };

    // 3. Confirm Action (The Nuke)
    document.getElementById('confirmDeleteRoomBtn').onclick = async () => {
      try {
        const btn = document.getElementById('confirmDeleteRoomBtn');
        btn.textContent = "Deleting...";
        
        // Remove from Database
        await db.ref('rooms/' + roomId).remove();
        
        // Redirect to Lobby
        window.location.href = 'See-You-Latte-Rooms.html';
      } catch (e) {
        console.error(e);
        alert("Error deleting room."); 
        document.getElementById('deleteRoomModal').classList.remove('active');
      }
    };

    // INIT
    loadRoom();

  </script>
</body>

</html>
